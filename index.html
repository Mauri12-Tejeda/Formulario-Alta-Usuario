<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Alta de Usuario - Ministerio de Seguridad</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#003366;padding:20px;margin:0}
    .formulario{background:#f2f2f2;padding:20px;border-radius:10px;max-width:900px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,.1);width:100%}

    /* ===== Encabezado ===== */
    .encabezado{
      background:#fff;border:1px solid #cfcfcf;border-radius:6px;margin-bottom:16px;overflow:hidden
    }
    .enc-top{display:flex;align-items:center;gap:16px;padding:10px 14px}
    .enc-logo{flex:0 0 180px;display:flex;align-items:center;justify-content:center;border-right:1px solid #e0e0e0;padding-right:12px;min-height:56px;background:#fafafa}
    .enc-logo img{max-height:42px;max-width:160px;object-fit:contain}
    .enc-titulos{flex:1;text-align:center;padding:4px 8px}
    .enc-titulo{font-size:24px;font-weight:700;color:#111;margin:0;line-height:1.2}
    .enc-sub{margin:2px 0 0 0;font-size:14px;color:#1a1a1a;font-weight:600}
    .enc-barra{background:#dddddd;color:#000;font-weight:700;padding:8px 14px;border-top:1px solid #cfcfcf;font-size:16px}
    /* ====================== */

    h1,h2{text-align:center;margin-bottom:10px}
    .seccion{margin-bottom:20px;border:1px solid #999;padding:15px;border-radius:5px}
    .seccion h3{background:#007BFF;color:#fff;padding:5px 10px;margin:-15px -15px 15px -15px;font-size:16px}
    .grupo{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    .campo{flex:1 1 200px;display:flex;flex-direction:column}
    label{font-weight:bold;margin-bottom:5px}
    input{padding:4px 8px;border:1px solid #ccc;border-radius:4px;height:32px;font-size:12px;box-sizing:border-box}
    input:focus {
    outline: none;
    border-color: #ffcc00;
    box-shadow: 0 0 8px rgba(255, 200, 0, 0.9);
    background-color: #fff6d6; /* un poco más fuerte al escribir */
    }
    button{padding:10px 20px;background:#007BFF;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-top:10px}
    button:hover{background:#0056b3}

    /* Contenedor del clon (fuera de pantalla) */
    #pdfContainer{
      position:fixed; top:0; left:-99999px;
      width:800px; background:#fff; padding:0; margin:0;
      pointer-events:none; z-index:0;
    }
    #pdfContainer .formulario{box-shadow:none;margin:0;max-width:none;width:800px}
  </style>
</head>
<body>

<form id="formAlta" class="formulario">

  <!-- Encabezado con logo (poné el archivo en la misma carpeta con este nombre) -->
  <div class="encabezado">
    <div class="enc-top">
      <div class="enc-logo">
      </div>
      <div class="enc-titulos">
        <h1 class="enc-titulo">Directorio Activo - Dominio</h1>
        <div class="enc-sub">Ministerio de Seguridad - CABA</div>
      </div>
    </div>
    <div class="enc-barra">Formulario de solicitud Alta de Usuario de Windows</div>
  </div>

  <div class="seccion">
    <h3>Solicitud</h3>
    <div class="grupo">
      <div class="campo">
        <label for="fecha">Fecha de Solicitud</label>
        <input type="date" id="fecha" name="fecha">
      </div>
    </div>
  </div>

  <div class="seccion">
    <h3>Datos del Solicitante a Crear Usuario</h3>
    <div class="grupo">
      <div class="campo">
        <label>Apellido y Nombres</label>
        <input type="text" id="nombre" name="nombre">
      </div>
      <div class="campo">
        <label>Nro de CUIL</label>
        <input type="text" id="cuil" name="cuil" maxlength="11" oninput="validarNumeros(this)" pattern="\d*" title="Solo números">
      </div>
    </div>
    <div class="grupo">
      <div class="campo">
        <label>LP</label>
        <input type="text" id="lp" name="lp">
      </div>
      <div class="campo">
        <label>Grado/Jerarquía</label>
        <input type="text" id="grado" name="grado">
      </div>
    </div>
    <div class="grupo">
      <div class="campo">
        <label>Subsecretaría / Superintendencia</label>
        <input type="text" id="subsecretaria" name="subsecretaria">
      </div>
    </div>
    <div class="grupo">
      <div class="campo">
        <label>División / Departamento</label>
        <input type="text" id="division" name="division">
      </div>
      <div class="campo">
        <label>Dependencia</label>
        <input type="text" id="dependencia" name="dependencia">
      </div>
    </div>
    <div class="grupo">
      <div class="campo">
        <label>Calle</label>
        <input type="text" id="calle" name="calle">
      </div>
      <div class="campo">
        <label>Nro</label>
        <input type="text" id="nro" name="nro" oninput="validarNumeros(this)" pattern="\d*" title="Solo números">
      </div>
      <div class="campo">
        <label>Piso</label>
        <input type="text" id="piso" name="piso" oninput="validarNumeros(this)" pattern="\d*" title="Solo números">
      </div>
    </div>
    <div class="grupo">
      <div class="campo">
        <label>E-mail Personal Institucional</label>
        <input type="email" id="email" name="email">
      </div>
      <div class="campo">
        <label>Teléfono / Interno</label>
        <input type="text" id="telefono" name="telefono" oninput="validarNumeros(this)" pattern="\d*" title="Solo números">
      </div>
    </div>
  </div>

  <div class="seccion">
    <h3>Responsable de la Dependencia</h3>
    <div class="grupo">
      <div class="campo">
        <label>Apellido y Nombres</label>
        <input type="text" id="resp_nombre" name="resp_nombre">
      </div>
      <div class="campo">
        <label>Cargo</label>
        <input type="text" id="resp_cargo" name="resp_cargo">
      </div>
      <div class="campo">
        <label>LP</label>
        <input type="text" id="resp_lp" name="resp_lp">
      </div>
    </div>
    <div class="grupo">
      <div class="campo">
        <label>División / Departamento</label>
        <input type="text" id="resp_division" name="resp_division">
      </div>
      <div class="campo">
        <label>E-mail Institucional</label>
        <input type="email" id="resp_email" name="resp_email">
      </div>
      <div class="campo">
        <label>Teléfono / Interno</label>
        <input type="text" id="resp_telefono" name="resp_telefono" oninput="validarNumeros(this)" pattern="\d*" title="Solo números">
      </div>
    </div>
  </div>

  <button type="button" id="btnPDF" onclick="descargarFormulario()">Generar PDF</button>
</form>

<!-- Segunda hoja: Instrucciones (oculta en pantalla, solo para PDF) -->
<div id="instrucciones" style="display:none; background:#fff; padding:30px; max-width:800px; margin:auto; font-size:13px; line-height:1.5;">
  <h2 style="text-align:center; margin-bottom:20px;">Instrucciones para completar el formulario</h2>
  <ol>
    <li>Completar Fecha del requerimiento.</li>
    <li>Datos del solicitante.<br>
      Completar con los datos de la Persona a dar de alta como Usuario de Dominio. 
      Ante cualquier consulta comunicarse al correo electrónico: 
      <b>dominio_mjys@buenosaires.gob.ar</b>
    </li>
  </ol>
  <p>A. Indicar Número de CUIL.<br>
  B. Indicar LP del Usuario (Personal contratado no completar).<br>
  C. Indicar Dependencia en la cual realiza sus actividades.<br>
  D. Indicar División/Departamento a la cual pertenece.<br>
  E. Indicar Ubicación de la Dependencia.<br>
  F. Indicar Correo electrónico del solicitante (@buenosaires.gob.ar, @policiadelaciudad.gob.ar).<br>
  En caso de no poseerlo, realizar la solicitud correspondiente (para más información dirigirse a la intranet).<br>
  G. Indicar teléfono de la División/Departamento donde ejerce sus funciones.</p>

  <p>3. Indicar Sistemas, Servidores o Conexión VPN a los cuales va acceder con sus credenciales.</p>
  <p>4. Datos del Responsable:<br>
  A. Indicar el Apellido/Nombre del responsable de la División/Departamento.<br>
  B. Indicar Cargo/LP del responsable de la División/Departamento.<br>
  C. Indicar email/teléfono del responsable de la División/Departamento.</p>

  <p style="color:#0033cc; font-weight:bold; margin-top:20px;">
    IMPORTANTE: NO SE RECIBEN FORMULARIOS ESCRITOS A MANO.
  </p>
</div>

<!-- contenedor fuera de pantalla para el clon -->
<div id="pdfContainer"></div>
<input type="date" id="fecha">
<script>
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  document.getElementById('fecha').value = `${yyyy}-${mm}-${dd}`; // SIEMPRE ISO

  function validarNumeros(i){ i.value = i.value.replace(/[^0-9]/g,''); }

  function formatearFecha(iso){
    const f = new Date(iso + 'T00:00:00');
    const d = String(f.getDate()).padStart(2,'0');
    const m = String(f.getMonth()+1).padStart(2,'0');
    const y = f.getFullYear();
    return `${d}/${m}/${y}`;
  }

  

async function descargarFormulario(){
  try{
    const jspdfMod = window.jspdf;
    if(!jspdfMod || !jspdfMod.jsPDF){
      alert('No se pudo cargar jsPDF.');
      return;
    }
    const { jsPDF } = jspdfMod;

    const form = document.querySelector('.formulario');
    const pdfContainer = document.getElementById('pdfContainer');

    // --- PRIMERA PARTE: Formulario ---
    const clon = form.cloneNode(true);

    // Quitar botón
    const btn = clon.querySelector('#btnPDF');
    if (btn) btn.remove();

    // Fecha legible
    const f = clon.querySelector('#fecha');
    if (f){
      f.type = 'text';
      if (f.value){
        const d = new Date(f.value + 'T00:00:00');
        f.value = String(d.getDate()).padStart(2,'0') + '/' +
                  String(d.getMonth()+1).padStart(2,'0') + '/' +
                  d.getFullYear();
      }
    }

    // Forzar ancho estable y asegurar visibilidad para layout
    clon.style.maxWidth = 'none';
    clon.style.width = '800px';
    clon.style.visibility = 'visible';

    pdfContainer.innerHTML = '';
    pdfContainer.appendChild(clon);

    const canvas = await html2canvas(clon, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      logging: false
    });

    if (!canvas || !canvas.width || !canvas.height){
      throw new Error('Canvas inválido (ancho/alto 0) para el formulario.');
    }

    const doc = new jsPDF('p','mm','a4');
    const margin = 10; // mm
    const pageWidth  = Number(doc.internal.pageSize.getWidth());
    const pageHeight = Number(doc.internal.pageSize.getHeight());
    const pdfWidth   = Number((pageWidth - margin*2).toFixed(3));
    const pdfHeight  = Number((pageHeight - margin*2).toFixed(3));

    const scaleW = pdfWidth / canvas.width;             // mm/px
    const imgHeight = Number((canvas.height * scaleW).toFixed(3));

    if (!isFinite(pdfWidth) || !isFinite(imgHeight) || pdfWidth <= 0 || imgHeight <= 0){
      throw new Error('Dimensiones inválidas para addImage (formulario).');
    }

    let heightLeft = imgHeight;
    let yPos = margin;

    const imgData = canvas.toDataURL('image/jpeg', 0.98);
    doc.addImage(imgData, 'JPEG', margin, yPos, pdfWidth, imgHeight);
    heightLeft -= pdfHeight;

    while (heightLeft > 0){
      doc.addPage();
      yPos = margin - (imgHeight - heightLeft);
      doc.addImage(imgData, 'JPEG', margin, yPos, pdfWidth, imgHeight);
      heightLeft -= pdfHeight;
    }

    // --- SEGUNDA PARTE: Instrucciones --- (REEMPLAZO)
const instrucciones = document.getElementById('instrucciones');
if (instrucciones) {
  // Clon y forzado de visibilidad (el original está display:none)
  const instClone = instrucciones.cloneNode(true);
  instClone.style.display = 'block';       // <— clave
  instClone.style.visibility = 'visible';  // <— clave
  instClone.style.width = '800px';
  instClone.style.maxWidth = 'none';
  instClone.style.background = '#ffffff';

  // Contenedor fuera de pantalla para render
  const contenedorTmp = document.createElement('div');
  contenedorTmp.style.position = 'fixed';
  contenedorTmp.style.left = '-99999px';
  contenedorTmp.style.top = '0';
  contenedorTmp.style.width = '800px';
  contenedorTmp.style.background = '#ffffff';
  contenedorTmp.style.visibility = 'visible';
  contenedorTmp.appendChild(instClone);
  document.body.appendChild(contenedorTmp);

  // Capturar
  const canvas2 = await html2canvas(contenedorTmp, {
    scale: 2,
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#ffffff',
    logging: false
  });

  if (!canvas2 || !canvas2.width || !canvas2.height) {
    document.body.removeChild(contenedorTmp);
    throw new Error('Canvas inválido (instrucciones).');
  }

  const imgData2 = canvas2.toDataURL('image/jpeg', 0.98);
  const scaleW2 = pdfWidth / canvas2.width;
  const imgHeight2 = Number((canvas2.height * scaleW2).toFixed(3));

  let rest2 = imgHeight2;
  let y2 = margin;

  doc.addPage();
  doc.addImage(imgData2, 'JPEG', margin, y2, pdfWidth, imgHeight2);
  rest2 -= pdfHeight;

  while (rest2 > 0) {
    doc.addPage();
    y2 = margin - (imgHeight2 - rest2);
    doc.addImage(imgData2, 'JPEG', margin, y2, pdfWidth, imgHeight2);
    rest2 -= pdfHeight;
  }

  document.body.removeChild(contenedorTmp);
}


    pdfContainer.innerHTML = '';
    doc.save('formulario_alta_usuario.pdf');

  }catch(err){
    console.error('Error al generar PDF:', err);
    alert('Error al generar PDF: ' + err.message);
  }
}




</script>
</body>
</html>







